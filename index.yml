jtype: Flow
version: '1'
with:
  port_expose: 45678
  no_debug_endpoints: True

executors:
  - name: 'segmenter'
    uses:
      jtype: IndexSentenceSegmenter
    py_modules:
      - executors.py
  - name: 'q_segmenter'
    uses:
      jtype: QuerySentenceSegmenter
    py_modules:
      - executors.py
  - name: 'encoder'
    uses: 'jinahub://TransformerTorchEncoder/v0.1'
    parallel: 1
    uses_with:
      pretrained_model_name_or_path: 'junnyu/wobert_chinese_base'
      pooling_strategy: 'cls'
      device: 'cpu'
      max_length: 256
      default_batch_size: 128
      default_traversal_paths:
        - 'c'
        - 'cc'
  - name: 'chunk_filter'
    uses:
      jtype: ChunkFilter
      with:
        traversal_paths: ['c',]
    py_modules:
      - executors.py
  - name: 'chunk_indexer'
    uses: 'jinahub://SimpleIndexer/v0.3'
    uses_metas:
       workspace: ${JINA_WORKSPACE_CHUNK}
  - name: 'chunk_chunk_filter'
    uses:
      jtype: ChunkFilter
      with:
        traversal_paths: ['cc',]
    py_modules:
      - executors.py
    needs: 'encoder'
  - name: 'chunk_chunk_indexer'
    uses: 'jinahub://SimpleIndexer/v0.3'
    uses_metas:
      workspace: ${JINA_WORKSPACE_CHUNK_CHUNK}
  - name: 'chunk_merger'
    uses:
      jtype: AggregateRanker
      with:
        is_distance: True
    py_modules:
      - executors.py
    needs:
      - 'chunk_indexer'
      - 'chunk_chunk_indexer'
  - name: 'name_segmenter'
    uses:
      jtype: IndexNameSegmenter
    py_modules:
      - executors.py
    needs: 'q_segmenter'
  - name: 'name_indexer'
    uses:
      jtype: BM25Indexer
    py_modules:
      - executors.py
  - name: 'case_num_segmenter'
    uses:
      jtype: CaseNumSegmenter
    py_modules:
      - executors.py
    needs: 'q_segmenter'
  - name: 'case_num_indexer'
    uses:
      jtype: BM25Indexer
    py_modules:
      - executors.py
  - name: 'merger'
    uses: 'jinahub://MatchMerger'
    uses_with:
      default_traversal_paths:
        - 'r'
        - 'c'
    needs: ['chunk_merger', 'chunk_chunk_indexer', 'name_indexer', 'case_num_indexer']
